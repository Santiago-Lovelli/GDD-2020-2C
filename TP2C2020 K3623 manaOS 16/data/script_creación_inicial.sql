--Creacion de esquema--------------------------------------------------------------------------------
USE GD2C2020
GO



CREATE SCHEMA [manaOS]
GO

--Creacion de tablas---------------------------------------------------------------------------------
BEGIN TRANSACTION transaccion_creacion_tablas

CREATE TABLE GD2C2020.manaOS.Caja(
	CAJA_CODIGO DECIMAL(18,0) NOT NULL IDENTITY(1,1) PRIMARY KEY,
	CAJA_DESC NVARCHAR(255),
);


-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.Motor (
	MOTOR_CODIGO DECIMAL(18,0) NOT NULL IDENTITY(1,1) PRIMARY KEY
);


-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.Transmision (
	TRANSMISION_CODIGO DECIMAL(18,0) NOT NULL IDENTITY(1,1) PRIMARY KEY,
	TRANSMISION_DESC NVARCHAR(255),
);



-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.Modelo (
	MODELO_CODIGO DECIMAL(18,0) NOT NULL IDENTITY(1,1) PRIMARY KEY,
	MODELO_NOMBRE NVARCHAR(255),
	MODELO_POTENCIA DECIMAL(18,0),
	TRANSMISION_CODIGO DECIMAL(18,0) NOT NULL,
	MOTOR_CODIGO DECIMAL(18,0) NOT NULL,
	CAJA_CODIGO DECIMAL(18,0) NOT NULL
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.TipoAuto (
	TIPO_AUTO_CODIGO DECIMAL(18,0) NOT NULL IDENTITY(1,1) PRIMARY KEY,
	TIPO_AUTO_DESC NVARCHAR(255),
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.Auto (
	AUTO_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	AUTO_CANT_KMS DECIMAL(18,0),
	AUTO_FECHA_ALTA DATETIME2(3),
	AUTO_NRO_CHASIS NVARCHAR(255),
	AUTO_NRO_MOTOR nvarchar (255),
	AUTO_PATENTE nvarchar (255),
	MODELO_CODIGO decimal(18,0) NOT NULL,
	FABRICANTE_ID int NOT NULL,
	TIPO_AUTO_ID int NOT NULL,
);


-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.Fabricante (
	FABRICANTE_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	FABRICANTE_NOMBRE VARCHAR(50)
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.AutoParte(
	AUTOPARTE_ID int NOT NULL IDENTITY(1,1) PRIMARY KEY,
	AUTO_PARTE_CODIGO decimal(18,0),
	AUTO_PARTE_DESCRIPCION nvarchar (255),
	FABRICANTE_ID int NOT NULL,
	MODELO_CODIGO decimal(18,0) NOT NULL
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.CompraDeAutoParte(
	COMPRA_AUTOPARTE_ID int NOT NULL IDENTITY(1,1) PRIMARY KEY,
	COMPRA_AUTOPARTE_PRECIO float,
	COMPRA_NRO decimal (18,0) NOT NULL,
	AUTOPARTE_ID int NOT NULL
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.FacturacionDeAutoParte(
	FACTURACION_AUTOPARTE_ID int NOT NULL IDENTITY(1,1) PRIMARY KEY,
	PRECIO_AUTOPARTE_FACTURADO float,
	FACTURA_NRO decimal (18,0) NOT NULL,
	AUTOPARTE_ID int NOT NULL
);


-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.FacturacionDeAuto(
	FACTURACION_AUTO_ID int NOT NULL IDENTITY(1,1) PRIMARY KEY,
	PRECIO_AUTO_FACTURADO float,
	FACTURA_NRO decimal (18,0) NOT NULL,
	AUTO_ID int NOT NULL
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.CompraDeAuto(
	COMPRA_AUTO_ID int NOT NULL IDENTITY(1,1) PRIMARY KEY,
	COMPRA_AUTO_PRECIO float,
	COMPRA_NRO decimal (18,0) NOT NULL,
	AUTO_ID int NOT NULL
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.Factura(
	FACTURA_NRO decimal (18,0) NOT NULL IDENTITY(1,1) PRIMARY KEY,
	FACTURA_FECHA datetime2 (3),
	CANT_FACTURADA decimal (18,0),
	PRECIO_FACTURADO decimal (18,0),
	CLIENTE_ID int NOT NULL,
	SUCURSAL_ID int NOT NULL,
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.Cliente(
	CLIENTE_ID int NOT NULL IDENTITY(1,1) PRIMARY KEY,
	CLIENTE_APELLIDO nvarchar (255) NOT NULL,
	CLIENTE_NOMBRE nvarchar (255) NOT NULL,
	CLIENTE_DIRECCION nvarchar (255),
	CLIENTE_DNI decimal (18,0),
	CLIENTE_MAIL nvarchar (255),
	CLIENTE_FECHA datetime2(3),
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.Compra(
	COMPRA_NRO decimal (18,0) NOT NULL IDENTITY(1,1) PRIMARY KEY,
	COMPRA_FECHA datetime2 (3),
	COMPRA_PRECIO decimal (18,0),
	COMPRA_CANT decimal (18,0),
	FACTURA_NRO decimal (18,0)
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.Sucursal(
	SUCURSAL_ID int NOT NULL IDENTITY(1,1) PRIMARY KEY,
	SUCURSAL_DIRECCION nvarchar(255),
	SUCURSAL_MAIL nvarchar (255),
	SUCURSAL_TELEFONO decimal (18,0),
	CIUDAD_ID int NOT NULL
);

-----------------------------------------------------------------------------------------------------

CREATE TABLE GD2C2020.manaOS.Ciudad(
	CIUDAD_ID int NOT NULL IDENTITY(1,1) PRIMARY KEY,
	CIUDAD_NOMBRE nvarchar(255)
);

--Agregamos las FK-----------------------------------------------------------------------------------

ALTER TABLE GD2C2020.manaOS.Modelo
   ADD CONSTRAINT FK_Modelo_Transmision FOREIGN KEY (TRANSMISION_CODIGO)
      REFERENCES GD2C2020.manaOS.Transmision (TRANSMISION_CODIGO)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

ALTER TABLE GD2C2020.manaOS.Modelo
   ADD CONSTRAINT FK_Modelo_Motor FOREIGN KEY (MOTOR_CODIGO)
      REFERENCES GD2C2020.manaOS.Motor (MOTOR_CODIGO)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

ALTER TABLE GD2C2020.manaOS.Modelo
   ADD CONSTRAINT FK_Modelo_Caja FOREIGN KEY (CAJA_CODIGO)
      REFERENCES GD2C2020.manaOS.Caja (CAJA_CODIGO)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

-----------------------------------------------------------------------------------------------------

ALTER TABLE GD2C2020.manaOS.Auto
   ADD CONSTRAINT FK_Auto_Modelo FOREIGN KEY (MODELO_CODIGO)
      REFERENCES GD2C2020.manaOS.Modelo(MODELO_CODIGO)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

ALTER TABLE GD2C2020.manaOS.Auto
   ADD CONSTRAINT FK_Auto_Fabricante FOREIGN KEY (FABRICANTE_ID)
      REFERENCES GD2C2020.manaOS.Fabricante(FABRICANTE_ID)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

ALTER TABLE GD2C2020.manaOS.Auto
   ADD CONSTRAINT FK_Auto_Tipo FOREIGN KEY (TIPO_AUTO_ID)
      REFERENCES GD2C2020.manaOS.TipoAuto(TIPO_AUTO_ID)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

-----------------------------------------------------------------------------------------------------

ALTER TABLE GD2C2020.manaOS.AutoParte
   ADD CONSTRAINT FK_AutoParte_Fabricante FOREIGN KEY (FABRICANTE_ID)
      REFERENCES GD2C2020.manaOS.Fabricante(FABRICANTE_ID)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

ALTER TABLE GD2C2020.manaOS.AutoParte
   ADD CONSTRAINT FK_AutoParte_Modelo FOREIGN KEY (MODELO_CODIGO)
      REFERENCES GD2C2020.manaOS.Modelo(MODELO_CODIGO)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

-----------------------------------------------------------------------------------------------------

ALTER TABLE GD2C2020.manaOS.CompraDeAutoParte
   ADD CONSTRAINT FK_CompraDeAutoParte_Compra FOREIGN KEY (COMPRA_NRO)
      REFERENCES GD2C2020.manaOS.Compra(COMPRA_NRO)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

ALTER TABLE GD2C2020.manaOS.CompraDeAutoParte
   ADD CONSTRAINT FK_CompraDeAutoParte_AutoParte FOREIGN KEY (AUTOPARTE_ID)
      REFERENCES GD2C2020.manaOS.AutoParte(AUTOPARTE_ID)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

-----------------------------------------------------------------------------------------------------

ALTER TABLE GD2C2020.manaOS.FacturacionDeAuto
   ADD CONSTRAINT FK_FacturacionDeAuto_Factura FOREIGN KEY (FACTURA_NRO)
      REFERENCES GD2C2020.manaOS.Factura(FACTURA_NRO)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

ALTER TABLE GD2C2020.manaOS.FacturacionDeAuto
   ADD CONSTRAINT FK_FacturacionDeAuto_Auto FOREIGN KEY (AUTO_ID)
      REFERENCES GD2C2020.manaOS.Auto(AUTO_ID)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

-----------------------------------------------------------------------------------------------------

ALTER TABLE GD2C2020.manaOS.CompraDeAuto
   ADD CONSTRAINT FK_CompraDeAuto_Compra FOREIGN KEY (COMPRA_NRO)
      REFERENCES GD2C2020.manaOS.Compra(COMPRA_NRO)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

ALTER TABLE GD2C2020.manaOS.CompraDeAuto
   ADD CONSTRAINT FK_CompraDeAuto_Auto FOREIGN KEY (AUTO_ID)
      REFERENCES GD2C2020.manaOS.Auto(AUTO_ID)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

-----------------------------------------------------------------------------------------------------

ALTER TABLE GD2C2020.manaOS.Factura
   ADD CONSTRAINT FK_Factura_Cliente FOREIGN KEY (CLIENTE_ID)
      REFERENCES GD2C2020.manaOS.Cliente(CLIENTE_ID)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

ALTER TABLE GD2C2020.manaOS.Factura
   ADD CONSTRAINT FK_Factura_Sucursal FOREIGN KEY (SUCURSAL_ID)
      REFERENCES GD2C2020.manaOS.Sucursal(SUCURSAL_ID)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

-----------------------------------------------------------------------------------------------------

ALTER TABLE GD2C2020.manaOS.Compra
   ADD CONSTRAINT FK_Compra_Factura FOREIGN KEY (FACTURA_NRO)
      REFERENCES GD2C2020.manaOS.Factura(FACTURA_NRO)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

-----------------------------------------------------------------------------------------------------

ALTER TABLE GD2C2020.manaOS.Sucursal
   ADD CONSTRAINT FK_Sucursal_Ciudad FOREIGN KEY (CIUDAD_ID)
      REFERENCES GD2C2020.manaOS.Ciudad(CIUDAD_ID)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

-----------------------------------------------------------------------------------------------------

ALTER TABLE GD2C2020.manaOS.FacturacionDeAutoParte
   ADD CONSTRAINT FK_FacturacionDeAutoParte_Factura FOREIGN KEY (FACTURA_NRO)
      REFERENCES GD2C2020.manaOS.Factura(FACTURA_NRO)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

ALTER TABLE GD2C2020.manaOS.FacturacionDeAutoParte
   ADD CONSTRAINT FK_FacturacionDeAutoParte_AutoParte FOREIGN KEY (AUTOPARTE_ID)
      REFERENCES GD2C2020.manaOS.AutoParte(AUTOPARTE_ID)
      ON DELETE CASCADE
      ON UPDATE CASCADE
;

COMMIT TRANSACTION transaccion_creacion_tablas

-----------------------------------------------------------------------------------------------------

USE GD2C2020
GO

------------------------ Funciones ------------------------
BEGIN TRANSACTION transaccion_creacion_funciones
GO

CREATE FUNCTION manaOS.fx_get_fabricante(@Nombre NVARCHAR(255))  
RETURNS INT  
BEGIN
	DECLARE @Result INT
    SET @Result = (SELECT f.[FABRICANTE_ID] FROM [GD2C2020].[manaOS].[Fabricante] f WHERE f.[FABRICANTE_NOMBRE] = @Nombre)
    RETURN @Result  
END 

GO

CREATE FUNCTION manaOS.fx_get_autoparte(@Codigo DECIMAL(18,0))  
RETURNS INT  
BEGIN
	DECLARE @Result INT
    SET @Result = (SELECT a.[AUTOPARTE_ID] FROM [GD2C2020].[manaOS].[AutoParte] a WHERE a.[AUTO_PARTE_CODIGO] = @Codigo)
    RETURN @Result  
END

GO

CREATE FUNCTION manaOS.fx_get_cliente(@apellido NVARCHAR(255)
,@nombre NVARCHAR(255)
,@direccion NVARCHAR(255)
,@dni DECIMAL(18,0)
,@fecha DATETIME2(3)
,@mail NVARCHAR(255))
RETURNS INT
BEGIN
	DECLARE @Result INT
    SET @Result = (SELECT TOP 1 c.CLIENTE_ID
		FROM [GD2C2020].[manaOS].[Cliente] c 
		WHERE c.CLIENTE_APELLIDO = @apellido
			AND c.CLIENTE_NOMBRE = @nombre
			AND c.CLIENTE_DIRECCION = @direccion
			AND c.CLIENTE_DNI = @dni
			AND c.CLIENTE_FECHA = @fecha
			AND c.CLIENTE_MAIL = @mail)
    RETURN @Result  
END

GO

CREATE FUNCTION manaOS.fx_get_sucursal(@direccion NVARCHAR(255)
      ,@mail NVARCHAR(255)
      ,@telefono DECIMAL(18,0)
      ,@ciudad NVARCHAR(255))
	  RETURNS INT
BEGIN
	DECLARE @Result INT
    SET @Result = (SELECT s.SUCURSAL_ID
		FROM [GD2C2020].[manaOS].[Sucursal] s
		INNER JOIN [GD2C2020].[manaOS].[Ciudad] c ON c.CIUDAD_NOMBRE = @ciudad
		WHERE s.SUCURSAL_DIRECCION = @direccion
		AND s.[SUCURSAL_MAIL] = @mail
		AND s.[SUCURSAL_TELEFONO] = @telefono
		AND s.CIUDAD_ID = c.CIUDAD_ID)
    RETURN @Result  
END 

GO

CREATE FUNCTION manaOS.fx_get_ciudad(@Ciudad NVARCHAR(255))  
RETURNS INT  
BEGIN
	DECLARE @Result INT
    SET @Result = (SELECT c.CIUDAD_ID FROM [GD2C2020].[manaOS].[Ciudad] c WHERE c.CIUDAD_NOMBRE=@Ciudad)
    RETURN @Result  
END 

GO

CREATE FUNCTION manaOS.fx_get_factura(@Codigo DECIMAL(18,0))  --La uso por el tema de que no exista la Faactura
RETURNS INT  
BEGIN
	DECLARE @Result INT
    SET @Result = (SELECT f.FACTURA_NRO FROM [GD2C2020].[manaOS].[Factura] f WHERE f.FACTURA_NRO = @Codigo)
    RETURN @Result  
END 

GO

CREATE FUNCTION manaOS.fx_get_auto(@Patente NVARCHAR(255))  
RETURNS INT  
BEGIN
	DECLARE @Result INT
    SET @Result = (SELECT a.AUTO_ID FROM [GD2C2020].[manaOS].[Auto] a WHERE a.AUTO_PATENTE = @Patente)
    RETURN @Result  
END 

GO

CREATE FUNCTION manaOS.fx_get_auto_precio(@Patente NVARCHAR(255))  
RETURNS INT  
BEGIN
	DECLARE @Result INT
    SET @Result = (SELECT a.AUTO_ID FROM [GD2C2020].[manaOS].[Auto] a WHERE a.AUTO_PATENTE = @Patente)
    RETURN @Result  
END 

GO

COMMIT TRANSACTION transaccion_creacion_funciones

------------------------ Entidades ------------------------
USE GD2C2020
GO

BEGIN TRANSACTION transaccion_migracion_datos

--Caja
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Caja] ON  
GO
INSERT INTO [GD2C2020].[manaOS].[Caja]
	([CAJA_CODIGO]
	,[CAJA_DESC])
	SELECT [TIPO_CAJA_CODIGO]
		,[TIPO_CAJA_DESC]
	FROM [GD2C2020].[gd_esquema].[Maestra]
	WHERE [TIPO_CAJA_CODIGO] IS NOT NULL
	GROUP BY [TIPO_CAJA_CODIGO]
		,[TIPO_CAJA_DESC]
	ORDER BY [TIPO_CAJA_CODIGO]
GO
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Caja] OFF
GO

--Transmision
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Transmision] ON  
GO
INSERT INTO [GD2C2020].[manaOS].[Transmision]
	([TRANSMISION_CODIGO]
	,[TRANSMISION_DESC])
	SELECT [TIPO_TRANSMISION_CODIGO]
		,[TIPO_TRANSMISION_DESC]
	FROM [GD2C2020].[gd_esquema].[Maestra]
	WHERE [TIPO_TRANSMISION_CODIGO] IS NOT NULL
	GROUP BY [TIPO_TRANSMISION_CODIGO]
		,[TIPO_TRANSMISION_DESC]
	ORDER BY [TIPO_TRANSMISION_CODIGO]
GO
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Transmision] OFF  
GO

--Motor
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Motor] ON  
GO
INSERT INTO [GD2C2020].[manaOS].[Motor]
	([MOTOR_CODIGO])
	SELECT [TIPO_MOTOR_CODIGO]
	FROM [GD2C2020].[gd_esquema].[Maestra]
	WHERE [TIPO_MOTOR_CODIGO] IS NOT NULL
	GROUP BY [TIPO_MOTOR_CODIGO]
	ORDER BY [TIPO_MOTOR_CODIGO]
GO
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Motor] OFF  
GO

--Modelo
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Modelo] ON  
GO
INSERT INTO [GD2C2020].[manaOS].[Modelo]
	([MODELO_CODIGO]
	,[MODELO_NOMBRE]
	,[MODELO_POTENCIA]
	,[MOTOR_CODIGO]
	,[TRANSMISION_CODIGO]
	,[CAJA_CODIGO])
	SELECT [MODELO_CODIGO]
		,[MODELO_NOMBRE]
		,[MODELO_POTENCIA]
		,[TIPO_MOTOR_CODIGO]
		,[TIPO_TRANSMISION_CODIGO]
		,[TIPO_CAJA_CODIGO]
	FROM [GD2C2020].[gd_esquema].[Maestra]
	WHERE [MODELO_CODIGO] IS NOT NULL
		and [MODELO_NOMBRE] IS NOT NULL
		and [MODELO_POTENCIA] IS NOT NULL
		and [TIPO_MOTOR_CODIGO] IS NOT NULL
		and [TIPO_TRANSMISION_CODIGO] IS NOT NULL
		and [TIPO_CAJA_CODIGO] IS NOT NULL
	GROUP BY [MODELO_CODIGO]
		,[MODELO_NOMBRE]
		,[MODELO_POTENCIA]
		,[TIPO_MOTOR_CODIGO]
		,[TIPO_TRANSMISION_CODIGO]
		,[TIPO_CAJA_CODIGO]
	ORDER BY [MODELO_CODIGO]
GO
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Modelo] OFF  
GO

--Fabricante
INSERT INTO [GD2C2020].[manaOS].[Fabricante]
([FABRICANTE_NOMBRE])
	SELECT [FABRICANTE_NOMBRE]
	FROM [GD2C2020].[gd_esquema].[Maestra]
	WHERE [FABRICANTE_NOMBRE] IS NOT NULL
	GROUP BY [FABRICANTE_NOMBRE]
	ORDER BY [FABRICANTE_NOMBRE]
GO

--AutoParte
INSERT INTO [GD2C2020].[manaOS].[AutoParte]
	([AUTO_PARTE_CODIGO]
	,[AUTO_PARTE_DESCRIPCION]
	,[FABRICANTE_ID]
	,[MODELO_CODIGO])
	SELECT m.[AUTO_PARTE_CODIGO]
		,m.[AUTO_PARTE_DESCRIPCION]
		,([manaOS].fx_get_fabricante(m.[FABRICANTE_NOMBRE])) AS FABRICANTE_ID
		,m.[MODELO_CODIGO]
	FROM [GD2C2020].[gd_esquema].[Maestra] m
	WHERE m.[AUTO_PARTE_CODIGO] IS NOT NULL
		AND m.[AUTO_PARTE_DESCRIPCION] IS NOT NULL
		AND m.[FABRICANTE_NOMBRE] IS NOT NULL
		AND m.[MODELO_CODIGO] IS NOT NULL
	GROUP BY m.[AUTO_PARTE_CODIGO]
		,m.[AUTO_PARTE_DESCRIPCION]
		,m.[FABRICANTE_NOMBRE]
		,m.[MODELO_CODIGO]
		,m.[FABRICANTE_NOMBRE]
	ORDER BY m.[AUTO_PARTE_CODIGO]
		,FABRICANTE_ID
GO

--Auto

INSERT INTO [GD2C2020].[manaOS].[Auto]
	([AUTO_CANT_KMS]
	,[AUTO_FECHA_ALTA]
	,[AUTO_NRO_CHASIS]
	,[AUTO_NRO_MOTOR]
	,[AUTO_PATENTE]
	,[FABRICANTE_ID]
	,[MODELO_CODIGO])
	SELECT [AUTO_CANT_KMS]
		,m.[AUTO_FECHA_ALTA]
		,m.[AUTO_NRO_CHASIS]
		,m.[AUTO_NRO_MOTOR]
		,m.[AUTO_PATENTE]
		,([manaOS].fx_get_fabricante(m.[FABRICANTE_NOMBRE])) AS FABRICANTE_ID
		,m.[MODELO_CODIGO]
	FROM [GD2C2020].[gd_esquema].[Maestra] m
	WHERE m.[AUTO_CANT_KMS] IS NOT NULL
		AND m.[AUTO_FECHA_ALTA] IS NOT NULL
		AND m.[AUTO_NRO_CHASIS] IS NOT NULL
		AND m.[AUTO_NRO_MOTOR] IS NOT NULL
		AND m.[AUTO_PATENTE] IS NOT NULL
		AND m.[FABRICANTE_NOMBRE] IS NOT NULL
		AND m.[MODELO_CODIGO] IS NOT NULL
	GROUP BY m.[AUTO_CANT_KMS]
		,m.[AUTO_FECHA_ALTA]
		,m.[AUTO_NRO_CHASIS]
		,m.[AUTO_NRO_MOTOR]
		,m.[AUTO_PATENTE]
		,m.[FABRICANTE_NOMBRE]
		,m.[MODELO_CODIGO]
	ORDER BY m.[AUTO_PATENTE]
		,FABRICANTE_ID
GO

--Cliente
INSERT INTO [GD2C2020].[manaOS].[Cliente]
	([CLIENTE_APELLIDO]
	,[CLIENTE_NOMBRE]
	,[CLIENTE_DIRECCION]
	,[CLIENTE_DNI]
	,[CLIENTE_FECHA]
	,[CLIENTE_MAIL])
	SELECT [CLIENTE_APELLIDO]
		,[CLIENTE_NOMBRE]
		,[CLIENTE_DIRECCION]
		,[CLIENTE_DNI]
		,[CLIENTE_FECHA_NAC]
		,[CLIENTE_MAIL]
	FROM [GD2C2020].[gd_esquema].[Maestra]
	WHERE [CLIENTE_APELLIDO] IS NOT NULL
		AND [CLIENTE_NOMBRE] IS NOT NULL
		AND [CLIENTE_DIRECCION] IS NOT NULL
		AND [CLIENTE_DNI] IS NOT NULL
		AND [CLIENTE_FECHA_NAC] IS NOT NULL
		AND [CLIENTE_MAIL] IS NOT NULL
	GROUP BY [CLIENTE_APELLIDO]
		,[CLIENTE_NOMBRE]
		,[CLIENTE_DIRECCION]
		,[CLIENTE_DNI]
		,[CLIENTE_FECHA_NAC]
		,[CLIENTE_MAIL]
	ORDER BY [CLIENTE_DNI]
GO


--Cliente 2

INSERT INTO [GD2C2020].[manaOS].[Cliente]
	([CLIENTE_APELLIDO]
	,[CLIENTE_NOMBRE]
	,[CLIENTE_DIRECCION]
	,[CLIENTE_DNI]
	,[CLIENTE_FECHA]
	,[CLIENTE_MAIL])
	SELECT [FAC_CLIENTE_APELLIDO]
		,[FAC_CLIENTE_NOMBRE]
		,[FAC_CLIENTE_DIRECCION]
		,[FAC_CLIENTE_DNI]
		,[FAC_CLIENTE_FECHA_NAC]
		,[FAC_CLIENTE_MAIL]
	FROM [GD2C2020].[gd_esquema].[Maestra]
	LEFT OUTER JOIN [GD2C2020].[manaOS].[Cliente] c ON (c.[CLIENTE_NOMBRE] = [FAC_CLIENTE_NOMBRE] AND c.[CLIENTE_APELLIDO] = [FAC_CLIENTE_APELLIDO] AND c.[CLIENTE_DNI] = [FAC_CLIENTE_DNI])
	WHERE [FACTURA_NRO] IS NOT NULL
		AND [FAC_CLIENTE_APELLIDO] IS NOT NULL
		AND [FAC_CLIENTE_NOMBRE] IS NOT NULL
		AND [FAC_CLIENTE_DIRECCION] IS NOT NULL
		AND [FAC_CLIENTE_DNI] IS NOT NULL
		AND [FAC_CLIENTE_FECHA_NAC] IS NOT NULL
		AND [FAC_CLIENTE_MAIL] IS NOT NULL
		AND c.CLIENTE_ID IS NULL
	GROUP BY [FACTURA_NRO]
		,[FAC_CLIENTE_APELLIDO]
		,[FAC_CLIENTE_NOMBRE]
		,[FAC_CLIENTE_DIRECCION]
		,[FAC_CLIENTE_DNI]
		,[FAC_CLIENTE_FECHA_NAC]
		,[FAC_CLIENTE_MAIL]
	ORDER BY [FACTURA_NRO]
GO

--Ciudad
INSERT INTO [GD2C2020].[manaOS].[Ciudad]
	(CIUDAD_NOMBRE)
	SELECT [SUCURSAL_CIUDAD]
	FROM [GD2C2020].[gd_esquema].[Maestra]
	WHERE [SUCURSAL_CIUDAD] IS NOT NULL
	GROUP BY [SUCURSAL_CIUDAD]
GO

--Sucursal
INSERT INTO [GD2C2020].[manaOS].[Sucursal]
	([SUCURSAL_DIRECCION]
	,[SUCURSAL_MAIL]
	,[SUCURSAL_TELEFONO]
	,[CIUDAD_ID])
	SELECT [SUCURSAL_DIRECCION]
		,[SUCURSAL_MAIL]
		,[SUCURSAL_TELEFONO]
		,(SELECT [manaOS].fx_get_ciudad([SUCURSAL_CIUDAD]) AS CIUDAD_ID)
	FROM [GD2C2020].[gd_esquema].[Maestra]
	WHERE [SUCURSAL_DIRECCION] IS NOT NULL
		AND [SUCURSAL_MAIL] IS NOT NULL
		AND [SUCURSAL_TELEFONO] IS NOT NULL
		AND [SUCURSAL_CIUDAD] IS NOT NULL
	GROUP BY [SUCURSAL_DIRECCION]
		,[SUCURSAL_MAIL]
		,[SUCURSAL_TELEFONO]
		,[SUCURSAL_CIUDAD]
GO

--TEMPORAL FACTURA

SELECT m.[FACTURA_NRO], c.CLIENTE_ID as CLIENTE_ID
INTO [GD2C2020].[manaOS].[Temporal_Factura]
FROM [GD2C2020].[gd_esquema].[Maestra] m
INNER JOIN [GD2C2020].[manaOS].[Cliente] c ON c.CLIENTE_APELLIDO = m.FAC_CLIENTE_APELLIDO AND c.CLIENTE_NOMBRE = m.FAC_CLIENTE_NOMBRE AND
                                              c.CLIENTE_DNI = m.FAC_CLIENTE_DNI AND c.CLIENTE_FECHA = m.FAC_CLIENTE_FECHA_NAC AND c.CLIENTE_MAIL = m.FAC_CLIENTE_MAIL
											  AND c.CLIENTE_DIRECCION = m.FAC_CLIENTE_DIRECCION
WHERE m.[FACTURA_NRO] IS NOT NULL
	AND m.[FAC_CLIENTE_APELLIDO] IS NOT NULL
	AND m.[FAC_CLIENTE_NOMBRE] IS NOT NULL
	AND m.[FAC_CLIENTE_DIRECCION] IS NOT NULL
	AND m.[FAC_CLIENTE_DNI] IS NOT NULL
	AND m.[FAC_CLIENTE_FECHA_NAC] IS NOT NULL
	AND m.[FAC_CLIENTE_MAIL] IS NOT NULL
GROUP BY m.[FACTURA_NRO]
	,c.[CLIENTE_ID]
GO

--Factura 
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Factura] ON
GO
INSERT INTO [GD2C2020].[manaOS].[Factura]
	([FACTURA_NRO]
	,[FACTURA_FECHA]
	,[PRECIO_FACTURADO]
	,[CLIENTE_ID]
	,[SUCURSAL_ID])
	SELECT m.[FACTURA_NRO]
		,m.[FACTURA_FECHA]
		,SUM(m.[PRECIO_FACTURADO]) as PRECIO_FACTURADO
		,tf.CLIENTE_ID as CLIENTE_ID
		, s.SUCURSAL_ID AS SUCURSAL_ID
	FROM [GD2C2020].[gd_esquema].[Maestra] m
	INNER JOIN [GD2C2020].[manaOS].[Temporal_Factura] tf  ON tf.[FACTURA_NRO] = m.[FACTURA_NRO] AND tf.CLIENTE_ID IS NOT NULL
	INNER JOIN [GD2C2020].[manaOS].[Sucursal] s ON s.SUCURSAL_DIRECCION = m.FAC_SUCURSAL_DIRECCION AND
												   s.SUCURSAL_TELEFONO = m.FAC_SUCURSAL_TELEFONO AND
												   s.SUCURSAL_MAIL = m.FAC_SUCURSAL_MAIL
	WHERE m.[FACTURA_NRO] IS NOT NULL
		AND m.[FACTURA_FECHA] IS NOT NULL
		AND m.[PRECIO_FACTURADO] IS NOT NULL
		AND m.[FAC_CLIENTE_APELLIDO] IS NOT NULL
		AND m.[FAC_CLIENTE_NOMBRE] IS NOT NULL
		AND m.[FAC_CLIENTE_DIRECCION] IS NOT NULL
		AND m.[FAC_CLIENTE_DNI] IS NOT NULL
		AND m.[FAC_CLIENTE_FECHA_NAC] IS NOT NULL
		AND m.[FAC_CLIENTE_MAIL] IS NOT NULL
		AND m.[FAC_SUCURSAL_DIRECCION] IS NOT NULL
		AND m.[FAC_SUCURSAL_MAIL] IS NOT NULL
		AND m.[FAC_SUCURSAL_TELEFONO] IS NOT NULL
		AND m.[FAC_SUCURSAL_CIUDAD] IS NOT NULL
	GROUP BY m.[FACTURA_NRO]
		,m.[FACTURA_FECHA]
		,m.[FAC_CLIENTE_APELLIDO]
		,m.[FAC_CLIENTE_NOMBRE]
		,m.[FAC_CLIENTE_DIRECCION]
		,m.[FAC_CLIENTE_DNI]
		,m.[FAC_CLIENTE_FECHA_NAC]
		,m.[FAC_CLIENTE_MAIL]
		,m.[FAC_SUCURSAL_DIRECCION]
		,m.[FAC_SUCURSAL_MAIL]
		,m.[FAC_SUCURSAL_TELEFONO]
		,m.[FAC_SUCURSAL_CIUDAD]
		,m.[FAC_SUCURSAL_DIRECCION]
		,m.[FAC_SUCURSAL_MAIL]
		,m.[FAC_SUCURSAL_TELEFONO]
		,m.[FAC_SUCURSAL_CIUDAD]
		,s.[SUCURSAL_ID]
		,tf.[CLIENTE_ID]
	ORDER BY m.[FACTURA_NRO], CLIENTE_ID
GO
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Factura] OFF
GO

--Compra

SELECT [COMPRA_NRO], [manaOS].fx_get_factura([FACTURA_NRO]) AS FAC_NRO
INTO [GD2C2020].[manaOS].[Temporal_Compra]
FROM [GD2C2020].[gd_esquema].[Maestra]
WHERE [COMPRA_NRO] IS NOT NULL
	AND [FACTURA_NRO] IS NOT NULL
GROUP BY [COMPRA_NRO]
	,[COMPRA_FECHA]
	,[COMPRA_PRECIO]
	,[COMPRA_CANT]
	,[FACTURA_NRO]
ORDER BY [COMPRA_NRO]
,[FACTURA_NRO]

SET IDENTITY_INSERT [GD2C2020].[manaOS].[Compra] ON
GO
INSERT INTO [GD2C2020].[manaOS].[Compra]
	([COMPRA_NRO]
	,[COMPRA_FECHA]
	,[COMPRA_PRECIO]
	,[COMPRA_CANT]
	,[FACTURA_NRO])
	SELECT m.[COMPRA_NRO]
		  ,m.[COMPRA_FECHA]
		  ,SUM(CASE WHEN m.[COMPRA_PRECIO] IS NULL THEN 0 ELSE m.[COMPRA_PRECIO] END) AS COMPRA_PRECIO
		  ,SUM(CASE WHEN m.[COMPRA_CANT] IS NULL THEN 0 ELSE m.[COMPRA_CANT] END) AS COMPRA_CANT
		  , (select tc.FAC_NRO from [GD2C2020].[manaOS].[Temporal_Compra] tc where tc.COMPRA_NRO = m.[COMPRA_NRO]) as Factura_Numero
	  FROM [GD2C2020].[gd_esquema].[Maestra] m
	  WHERE m.[COMPRA_NRO] IS NOT NULL
	  GROUP BY m.[COMPRA_NRO]
		  ,m.[COMPRA_FECHA]
	  ORDER BY m.[COMPRA_NRO]
GO
SET IDENTITY_INSERT [GD2C2020].[manaOS].[Compra] OFF
GO

--CompraDeAutoParte
INSERT INTO [GD2C2020].[manaOS].[CompraDeAutoParte]
	([AUTOPARTE_ID]
	,[COMPRA_AUTOPARTE_PRECIO]
	,[COMPRA_NRO])
	SELECT ap.[AUTOPARTE_ID]
		,m.[COMPRA_PRECIO]
		,m.[COMPRA_NRO]
	FROM [GD2C2020].[gd_esquema].[Maestra] m
	INNER JOIN [GD2C2020].[manaOS].[AutoParte] ap ON ap.AUTO_PARTE_CODIGO = m.AUTO_PARTE_CODIGO AND
													 ap.AUTO_PARTE_DESCRIPCION = m.AUTO_PARTE_DESCRIPCION
	WHERE m.[COMPRA_NRO] IS NOT NULL
		AND m.[COMPRA_PRECIO] IS NOT NULL
		AND m.[AUTO_PARTE_CODIGO] IS NOT NULL
	GROUP BY m.[COMPRA_NRO]
		,m.[COMPRA_PRECIO]
		,m.[AUTO_PARTE_CODIGO]
		, ap.[AUTOPARTE_ID]
	ORDER BY m.[AUTO_PARTE_CODIGO]
GO

--FacturacionDeAutoParte
INSERT INTO [GD2C2020].[manaOS].[FacturacionDeAutoParte]
	([FACTURA_NRO]
	,[PRECIO_AUTOPARTE_FACTURADO]
	,[AUTOPARTE_ID])
	SELECT [manaOS].fx_get_factura(m.[FACTURA_NRO]) as FACTURA_NRO
		,m.[PRECIO_FACTURADO]
		,ap.[AUTOPARTE_ID]
	FROM [GD2C2020].[gd_esquema].[Maestra] m
	INNER JOIN [GD2C2020].[manaOS].[AutoParte] ap ON ap.AUTO_PARTE_CODIGO = m.AUTO_PARTE_CODIGO AND
													 ap.AUTO_PARTE_DESCRIPCION = m.AUTO_PARTE_DESCRIPCION
	WHERE m.[FACTURA_NRO] IS NOT NULL
		AND m.[PRECIO_FACTURADO] IS NOT NULL
		AND m.[AUTO_PARTE_CODIGO] IS NOT NULL
	GROUP BY m.[FACTURA_NRO]
		,m.[PRECIO_FACTURADO]
		,m.[AUTO_PARTE_CODIGO]
		,ap.[AUTOPARTE_ID]
	ORDER BY m.[FACTURA_NRO], ap.[AUTOPARTE_ID]
GO

--FacturacionDeAuto
INSERT INTO [GD2C2020].[manaOS].[FacturacionDeAuto]
	([FACTURA_NRO]
	,[AUTO_ID]
	,[PRECIO_AUTO_FACTURADO])
	SELECT [manaOS].fx_get_factura(m.[FACTURA_NRO])
	  ,au.[AUTO_ID] as AUTO_ID
	  ,m.[PRECIO_FACTURADO]
	FROM [GD2C2020].[gd_esquema].[Maestra] m
	INNER JOIN [GD2C2020].[manaOS].Auto au ON au.AUTO_PATENTE = m.AUTO_PATENTE AND
											  au.AUTO_CANT_KMS = m.AUTO_CANT_KMS AND
											  au.AUTO_FECHA_ALTA = m.AUTO_FECHA_ALTA AND
											  au.AUTO_NRO_CHASIS = m.AUTO_NRO_CHASIS AND
											  au.AUTO_NRO_MOTOR = m.AUTO_NRO_MOTOR AND
											  au.MODELO_CODIGO = m.MODELO_CODIGO
	WHERE m.[FACTURA_NRO] IS NOT NULL
	  AND m.[PRECIO_FACTURADO] IS NOT NULL
	  AND m.[AUTO_PATENTE] IS NOT NULL
	GROUP BY m.[FACTURA_NRO]
	  ,m.[PRECIO_FACTURADO]
	  ,m.[AUTO_PATENTE]
	  ,au.[AUTO_ID]
	ORDER BY m.[AUTO_PATENTE]
GO

--CompraDeAuto
INSERT INTO [GD2C2020].[manaOS].[CompraDeAuto]
([AUTO_ID]
,[COMPRA_NRO]
,[COMPRA_AUTO_PRECIO])
SELECT au.[AUTO_ID] as AUTO_ID
	  ,m.[COMPRA_NRO]
	  ,m.[COMPRA_PRECIO]
	  FROM [GD2C2020].[gd_esquema].[Maestra] m
	  INNER JOIN [GD2C2020].[manaOS].[Auto] au ON au.AUTO_PATENTE = m.AUTO_PATENTE AND
											  au.AUTO_CANT_KMS = m.AUTO_CANT_KMS AND
											  au.AUTO_FECHA_ALTA = m.AUTO_FECHA_ALTA AND
											  au.AUTO_NRO_CHASIS = m.AUTO_NRO_CHASIS AND
											  au.AUTO_NRO_MOTOR = m.AUTO_NRO_MOTOR AND
											  au.MODELO_CODIGO = m.MODELO_CODIGO
	  WHERE m.[AUTO_PATENTE] IS NOT NULL
	  AND m.[COMPRA_NRO] IS NOT NULL
	  GROUP BY m.[COMPRA_NRO]
	  ,m.[COMPRA_PRECIO]
	  ,m.[AUTO_PATENTE]
	  ,au.[AUTO_ID]
	  ORDER BY m.[AUTO_PATENTE]
GO

COMMIT TRANSACTION transaccion_migracion_datos

-----------------------------------------------------------------------------------------------------